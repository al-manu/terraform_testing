name: Create AWS Resources (S3 Buckets)

on:
  push:
    branches:
      - 'feature/*'  # Adjust to your primary branch or trigger

jobs:
  create-resources:
    runs-on: ubuntu-latest
    permissions:
      id-token: write  # Required for OIDC
      contents: read   # Required for checking out the code
    environment:
      name: prod  # Adjust environment (prod, staging, etc.)
    
    env:
        AWS_ROLE_ARN: ${{ secrets.AWS_PROD_ROLE_ARN }}  # Use the AWS role for production
        AWS_REGION: ${{ secrets.AWS_REGION }}  # Use the AWS region from secrets
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      # Set up AWS credentials using OIDC authentication
      - name: Set up AWS OIDC credentials for dev environment
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: ${{ env.AWS_ROLE_ARN }}  # Use the environment variable
          aws-region: ${{ env.AWS_REGION }}  # Use the environment variable
          # role-session-name: github-actions-session

      # Create S3 buckets for state and lock
      - name: Create S3 buckets for Terraform state and lock
        run: |
          # Define bucket names (you could use the GitHub SHA or any naming convention)
          STATE_BUCKET_NAME="terraform-state-${{ github.sha }}"
          LOCK_BUCKET_NAME="terraform-lock-${{ github.sha }}"

          # Create the state bucket
          aws s3api create-bucket --bucket $STATE_BUCKET_NAME --create-bucket-configuration LocationConstraint=${{ secrets.AWS_REGION }}
          
          # Create the lock bucket (optional, for state locking)
          aws s3api create-bucket --bucket $LOCK_BUCKET_NAME --create-bucket-configuration LocationConstraint=${{ secrets.AWS_REGION }}

          # Output bucket names (this can be used in subsequent workflows)
          echo "state_bucket=$STATE_BUCKET_NAME" >> $GITHUB_ENV
          echo "lock_bucket=$LOCK_BUCKET_NAME" >> $GITHUB_ENV

          # Optionally, enable versioning (helpful for Terraform state)
          aws s3api put-bucket-versioning --bucket $STATE_BUCKET_NAME --versioning-configuration Status=Enabled
          aws s3api put-bucket-versioning --bucket $LOCK_BUCKET_NAME --versioning-configuration Status=Enabled

          echo "Created state and lock buckets: $STATE_BUCKET_NAME, $LOCK_BUCKET_NAME"
